{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0;">Conversation {{ conversation_id }}</h2>
  <p style="color:var(--muted); margin-top:6px;">{{ question }}</p>
  <div style="margin-top:10px;">
    <span class="pill">Members: {{ members|join(", ") }}</span>
    <span class="pill">Chairman: {{ chairman }}</span>
    <span class="pill">Turns: {{ turns_count }}</span>
    {% if meta and meta.error %}
      <span class="pill" style="background:#ffb3b3; color:#280000;">Error recorded</span>
    {% endif %}
    {% if meta and meta.error %}
      <p style="color:var(--muted); margin-top:6px;">Error: {{ meta.error }}</p>
    {% endif %}
  </div>
  <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
    <form method="post" action="{{ url_for('delete_conversation', conversation_id=conversation_id) }}">
      <button class="btn" type="submit" style="background:#ffb3b3;">Delete conversation</button>
    </form>
  </div>
</div>

<div class="card" id="live-card">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Live status</h3>
    <button class="btn" id="stop-btn" {% if not job %}style="display:none;"{% endif %}>Stop</button>
  </div>
  <div style="margin-top:10px;">
    Status: <span id="status-label" class="status pending">pending</span>
    <span class="pill" id="turn-label">Turn 1 / {{ turns_count }}</span>
  </div>
  <div class="grid" style="margin-top:12px;">
    <div>
      <h4>Stage 1: Opinions</h4>
      <div id="stage1-status"></div>
    </div>
    <div>
      <h4>Stage 2: Reviews</h4>
      <div id="stage2-status"></div>
    </div>
    <div>
      <h4>Stage 3: Chairman</h4>
      <div id="stage3-status"></div>
    </div>
  </div>
</div>

<div class="card" id="live-output-card">
  <h3 style="margin-top:0;">Live answers</h3>
  <div class="grid">
    <div>
      <h4>Advisor responses</h4>
      <div id="stage1-output"></div>
    </div>
    <div>
      <h4>Peer reviews</h4>
      <div id="stage2-output"></div>
    </div>
    <div>
      <h4>Chairman</h4>
      <div id="stage3-output"></div>
    </div>
  </div>
</div>

{% for turn in turns %}
  <div class="card">
    <h3 style="margin-top:0;">Turn {{ turn.turn_index }}</h3>
    <p style="color:var(--muted);">Prompt used for this turn:</p>
    <pre>{{ turn.turn_prompt }}</pre>

    <h4>Advisor answers</h4>
    {% for adv in turn.advisors %}
      <details>
        <summary style="display:flex; justify-content:space-between; align-items:center;">
          <span>{{ adv.provider }}</span>
          <span style="display:flex; gap:6px; align-items:center;">
            {% if adv.role %}<span class="status" style="border:1px solid rgba(255,255,255,0.15);">{{ adv.role }}</span>{% endif %}
          </span>
        </summary>
        <pre>{{ adv.answer }}</pre>
      </details>
    {% endfor %}

    <h4>Reviews</h4>
    {% for rev in turn.reviews %}
      <details>
        <summary>{{ rev.provider }}</summary>
        <pre>{{ rev.review }}</pre>
      </details>
    {% endfor %}

    <h4>Chairman ({{ turn.chairman.provider }})</h4>
    <pre>{{ turn.chairman.answer }}</pre>
  </div>
{% endfor %}

{% if not turns %}
  <div class="card">
    <p style="color:var(--muted);">No turn data recorded yet.</p>
  </div>
{% endif %}

<script>
  const conversationId = "{{ conversation_id }}";
  const members = {{ members | tojson }};
  const chairman = "{{ chairman }}";
  const turnsTotal = {{ turns_count }};
  const statusLabel = document.getElementById("status-label");
  const turnLabel = document.getElementById("turn-label");
  const stopBtn = document.getElementById("stop-btn");
  window.__roleMap = {};

  function renderStage(containerId, mapping) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const entries = Object.entries(mapping || {});
    if (!entries.length) {
      container.innerHTML = "<p style='color:var(--muted);'>No data yet.</p>";
      return;
    }
    entries.forEach(([provider, statusData]) => {
      const status = typeof statusData === "string" ? statusData : statusData.status;
      const role = (window.__roleMap || {})[provider];
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.marginBottom = "4px";
      const name = document.createElement("span");
      name.textContent = provider;
      row.appendChild(name);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";
      const statusEl = document.createElement("span");
      statusEl.className = `status ${status}`;
      statusEl.textContent = status;
      right.appendChild(statusEl);
      if (role) {
        const chip = document.createElement("span");
        chip.className = `status`;
        chip.style.border = "1px solid rgba(255,255,255,0.15)";
        chip.textContent = role;
        right.appendChild(chip);
      }
      row.appendChild(right);
      container.appendChild(row);
    });
  }

  function renderOutput(containerId, mapping) {
    const container = document.getElementById(containerId);
    const openSet = new Set(
      Array.from(container.querySelectorAll("details[open]")).map((d) => d.dataset.provider || "")
    );
    container.innerHTML = "";
    const entries = Object.entries(mapping || {});
    if (!entries.length) {
      container.innerHTML = "<p style='color:var(--muted);'>No data yet.</p>";
      return;
    }
    entries.forEach(([provider, data]) => {
      const message = typeof data === "object" ? data.message : "";
      if (!message) return;
      const role = (window.__roleMap || {})[provider];
      const details = document.createElement("details");
      details.style.marginBottom = "8px";
      details.dataset.provider = provider;
      if (openSet.has(provider)) {
        details.open = true;
      }
      const summary = document.createElement("summary");
      summary.style.display = "flex";
      summary.style.justifyContent = "space-between";
      summary.style.alignItems = "center";
      const label = document.createElement("span");
      label.textContent = provider;
      summary.appendChild(label);
      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";
      right.style.alignItems = "center";
      if (role) {
        const chip = document.createElement("span");
        chip.className = "status";
        chip.style.border = "1px solid rgba(255,255,255,0.15)";
        chip.textContent = role;
        right.appendChild(chip);
      }
      summary.appendChild(right);
      details.appendChild(summary);
      const pre = document.createElement("pre");
      pre.textContent = message;
      details.appendChild(pre);
      container.appendChild(details);
    });
  }

  function renderStatus(data) {
    const jobStatus = data.job_status || data.status || "pending";
    statusLabel.textContent = jobStatus;
    statusLabel.className = `status ${jobStatus}`;
    turnLabel.textContent = `Turn ${data.turn || 1} / ${data.turns || turnsTotal}`;
    window.__roleMap = data.roles || {};
    renderStage("stage1-status", data.stage1 || {});
    renderStage("stage2-status", data.stage2 || {});
    renderStage("stage3-status", data.stage3 || {});
    renderOutput("stage1-output", data.stage1 || {});
    renderOutput("stage2-output", data.stage2 || {});
    renderOutput("stage3-output", data.stage3 || {});

    if (jobStatus === "running") {
      stopBtn.style.display = "inline-block";
      stopBtn.disabled = false;
    } else {
      stopBtn.disabled = true;
      stopBtn.style.display = "none";
      const liveCard = document.getElementById("live-card");
      if (liveCard) {
        liveCard.style.display = "none";
      }
      const liveOutputCard = document.getElementById("live-output-card");
      if (liveOutputCard) {
        liveOutputCard.style.display = "none";
      }
    }
  }

  async function pollStatus() {
    try {
      const res = await fetch(`/conversations/${conversationId}/status`);
      if (!res.ok) return;
      const data = await res.json();
      renderStatus(data);
      if (data.job_status === "running") {
        setTimeout(pollStatus, 1200);
      }
    } catch (err) {
      console.error(err);
    }
  }

  if (stopBtn) {
    stopBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      stopBtn.disabled = true;
      stopBtn.textContent = "Stopping...";
      await fetch(`/conversations/${conversationId}/stop`, { method: "POST" });
      setTimeout(pollStatus, 500);
    });
  }

  pollStatus();
</script>
{% endblock %}
